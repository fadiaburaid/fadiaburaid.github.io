<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
		<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
		<meta http-equiv="Permissions-Policy" content="interest-cohort=()">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <title>AI Avatar Resume</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Exo:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://cdn.socket.io/4.1.2/socket.io.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad/dist/index.browser.js"></script>
		<script async src="https://ga.jspm.io/npm:es-module-shims@1.7.3/dist/es-module-shims.js"></script>

        <style>
            body {
                font-family: sans-serif;
                font-family: "Exo", sans-serif;

                background: #000000;
                color: white;
            }
            h1 {
                text-align: center;
                font-weight: lighter;
            }
            textarea {
                display: block;
                margin: 0 auto;
                width: 100%;
				height: 300px;
                rows: 3;
                padding: 10px;
                font-size: 2rem;
				text-align: center;
                background: #000000;
                color: white;
                font-family: "Exo", sans-serif;
                border: none;
                border-radius: 5px;
                pointer-events: none;
            }
			canvas {
				padding-left: 0;
				padding-right: 0;
				margin-left: auto;
				margin-right: auto;
				display: block;
			}
        </style>
    </head>
    <body>
        <h1>AI Avatar Resume</h1>
		<canvas id="avatarCanvas"></canvas>
        <p id="status"></p>
        <textarea id="output"></textarea>
    </body>

	<script type="importmap">
		{
			"imports": {
				"three": "https://threejs.org/build/three.module.js",
				"three/addons/": "./jsm/"
			}
		}
	</script>
	<script type="module">
		import * as THREE from 'three';

		//import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
		import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

		import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
		import { KTX2Loader } from 'three/addons/loaders/KTX2Loader.js';
		import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';

		import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

		const blendshapesMap = {
			// '_neutral': '',
			'browDownLeft': 'browDownLeft',
			'browDownRight': 'browDownRight',
			'browInnerUp': 'browInnerUp',
			'browOuterUpLeft': 'browOuterUpLeft',
			'browOuterUpRight': 'browOuterUpRight',
			'cheekPuff': 'cheekPuff',
			'cheekSquintLeft': 'cheekSquintLeft',
			'cheekSquintRight': 'cheekSquintRight',
			'eyeBlinkLeft': 'eyeBlinkLeft',
			'eyeBlinkRight': 'eyeBlinkRight',
			'eyeLookDownLeft': 'eyeLookDownLeft',
			'eyeLookDownRight': 'eyeLookDownRight',
			'eyeLookInLeft': 'eyeLookInLeft',
			'eyeLookInRight': 'eyeLookInRight',
			'eyeLookOutLeft': 'eyeLookOutLeft',
			'eyeLookOutRight': 'eyeLookOutRight',
			'eyeLookUpLeft': 'eyeLookUpLeft',
			'eyeLookUpRight': 'eyeLookUpRight',
			'eyeSquintLeft': 'eyeSquintLeft',
			'eyeSquintRight': 'eyeSquintRight',
			'eyeWideLeft': 'eyeWideLeft',
			'eyeWideRight': 'eyeWideRight',
			'jawForward': 'jawForward',
			'jawLeft': 'jawLeft',
			'jawOpen': 'jawOpen',
			'jawRight': 'jawRight',
			'mouthClose': 'mouthClose',
			'mouthDimpleLeft': 'mouthDimpleLeft',
			'mouthDimpleRight': 'mouthDimpleRight',
			'mouthFrownLeft': 'mouthFrownLeft',
			'mouthFrownRight': 'mouthFrownRight',
			'mouthFunnel': 'mouthFunnel',
			'mouthLeft': 'mouthLeft',
			'mouthLowerDownLeft': 'mouthLowerDownLeft',
			'mouthLowerDownRight': 'mouthLowerDownRight',
			'mouthPressLeft': 'mouthPressLeft',
			'mouthPressRight': 'mouthPressRight',
			'mouthPucker': 'mouthPucker',
			'mouthRight': 'mouthRight',
			'mouthRollLower': 'mouthRollLower',
			'mouthRollUpper': 'mouthRollUpper',
			'mouthShrugLower': 'mouthShrugLower',
			'mouthShrugUpper': 'mouthShrugUpper',
			'mouthSmileLeft': 'mouthSmileLeft',
			'mouthSmileRight': 'mouthSmileRight',
			'mouthStretchLeft': 'mouthStretchLeft',
			'mouthStretchRight': 'mouthStretchRight',
			'mouthUpperUpLeft': 'mouthUpperUpLeft',
			'mouthUpperUpRight': 'mouthUpperUpRight',
			'noseSneerLeft': 'noseSneerLeft',
			'noseSneerRight': 'noseSneerRight',
			// '': 'tongueOut'
		};

		//

		const renderer = new THREE.WebGLRenderer( { canvas: avatarCanvas } );
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth/1.5, window.innerHeight/1.5);
		renderer.toneMapping = THREE.ACESFilmicToneMapping;

		const camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 100 );
		camera.position.set( 0, 1.5, 2);	
		//camera.position.z = 5;
		let mixer,clips,actions, activeAction, previousAction;
		let clock = new THREE.Clock();

		const scene = new THREE.Scene();
		scene.scale.x = - 1;

		const environment = new RoomEnvironment();
		const pmremGenerator = new THREE.PMREMGenerator( renderer );

		scene.background = new THREE.Color( 0x666666 );
		scene.environment = pmremGenerator.fromScene( environment ).texture;

		//const controls = new OrbitControls( camera, renderer.domElement );

		// Face

		const ktx2Loader = new KTX2Loader()
			.setTranscoderPath( "./basis/" )
			.detectSupport( renderer );

		let head,lefteye,righteye,teeth;
		
		new GLTFLoader()
			.setKTX2Loader( ktx2Loader )
			.setMeshoptDecoder( MeshoptDecoder )
			.load( "./avatars/fadi-formal-rig.glb", ( gltf ) => {

				const mesh = gltf.scene.children[ 0 ];
				scene.add( mesh );
				
				mixer = new THREE.AnimationMixer( mesh );
				clips = gltf.animations;
				
				
				actions = {};
				for ( let i = 0; i < clips.length; i ++ ) {

					const clip = clips[ i ];
					const action = mixer.clipAction( clip );
					actions[ clip.name ] = action;

				}
				
				//idle1,idle2,idle3,talking1,talking2,talking3,thinking
				//idle1 = mixer.clipAction( clips[0] );
				//talk2 = mixer.clipAction( clips[5] );
				activeAction=actions[ 'idle1' ];
				activeAction.play();
				
				//const head = mesh.getObjectByName( 'Wolf3D_Avatar' );
				head = mesh.getObjectByName( 'Wolf3D_Head' );
				lefteye = scene.getObjectByName( 'EyeLeft' );
				righteye = scene.getObjectByName( 'EyeRight' );
				teeth = scene.getObjectByName( 'Wolf3D_Teeth' );
				
				/*
				// GUI

				const gui = new GUI();
				gui.close();

				const influences = head.morphTargetInfluences;

				for ( const [ key, value ] of Object.entries( head.morphTargetDictionary ) ) {

					gui.add( influences, value, 0, 1, 0.01 )
						.name( key.replace( 'blendShape1.', '' ) )
						.listen( influences );

				}
				*/
				
				const values1 = [ 0,0.5,0,0];
				const values2 = [ 0,0,0,0.5];
				
				let i=0;
				var blink = function(){
				  //close the eyes
				  head.morphTargetInfluences[ 65 ] = 1;
				  head.morphTargetInfluences[ 66 ] = 1;
				  setTimeout(function(){
					//open them again
				  head.morphTargetInfluences[ 65 ] = 0;
				  head.morphTargetInfluences[ 66 ] = 0;
				  }, 200);
				  lefteye.morphTargetInfluences[ 42 ] = values1[i]; // left eye look in
				  righteye.morphTargetInfluences[ 45 ] = values1[i]; //right eye look out
				  lefteye.morphTargetInfluences[ 44 ] = values2[i]; // left eye look out
				  righteye.morphTargetInfluences[ 43 ] = values2[i]; // right eye look in
				  i++;
				  if (i == values1.length) {
					i = 0;
				  }
				};

				setInterval(blink, 3000);
									
				renderer.setAnimationLoop( animation );

			} );
			
		function animation() {
			/*
					const index = face.morphTargetDictionary[ blendshapesMap[  categoryName ] ];

					if ( index !== undefined ) {

						face.morphTargetInfluences[ index ] = score;
						lefteye.morphTargetInfluences[ index ] = score;
						righteye.morphTargetInfluences[ index ] = score;
						teeth.morphTargetInfluences[ index ] = score;

					}
			*/
			const mixerUpdateDelta = clock.getDelta();
			mixer.update( mixerUpdateDelta );


			renderer.render( scene, camera );

			//controls.update();

		}

		window.addEventListener( 'resize', function () {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		} );
		
		
		const output = document.getElementById("output");
        const status = document.getElementById("status");
		let audio
		
        async function main() {
            const socket = io("http://45.76.206.121");

            socket.on("connect", async () => {
                const myvad = await vad.MicVAD.new({
                    positiveSpeechThreshold: 0.8,
                    negativeSpeechThreshold: 0.8 - 0.15,
                    minSpeechFrames: 2,
                    preSpeechPadFrames: 8,
                    redemptionFrames: 3,
                    onSpeechStart: () => {
                        console.log("Speech start detected");
                        status.innerText = "Listening...";
                    },
                    onSpeechEnd: (audio) => {
                        status.innerText = "Processing...";
                        const wavBuffer = vad.utils.encodeWAV(audio);
                        const base64 = vad.utils.arrayBufferToBase64(wavBuffer);
                        socket.emit("audio_data", base64);
                    },
                });
                myvad.start();
            });
            socket.on("transcription", (data) => {
                status.innerText = "";
                output.value = (data)
                    .replace(".", " ")
                    .replace("  ", " ");
            });
			
			socket.on("reply", (data) => {
                status.innerText = "";
                output.value = (output.value + data)
                    .replace(".", " ")
                    .replace("  ", " ");
			
				/*
				const url = "{{ url_for('static', filename='visemes.txt')}}";
				fetch(url)
				   .then( r => r.text() )
				   .then( t => process_visemes(t))
				
				audio = new Audio("./static/speech.wav?cb=" + new Date().getTime());				
				audio.load();
				*/
            });
			socket.on("audio", (data) => {
				audio = new Audio("data:audio/wav;base64," + data);				
            });
			
			socket.on("visemes", (data) => {
				process_visemes(data)
            });
			
        }
        
		let count,playvsms;
		let ocls_phnms=[];
		function process_visemes(jali_vsms) {
        let splitLines = jali_vsms.split(/\r?\n/);
		for (let r = 0; r < splitLines.length; r++) {
			let jali_phnms=splitLines[r].split(",").map(function(item){
			  return item.trim();
			});;
			ocls_phnms[r]=[0,Number(jali_phnms[19]),Number(jali_phnms[20]),Number(jali_phnms[15]),0,Number(jali_phnms[18]),(Number(jali_phnms[16])+Number(jali_phnms[14]))/2,Number(jali_phnms[13]),Number(jali_phnms[17]),Number(jali_phnms[12]),(Number(jali_phnms[2])+Number(jali_phnms[3]))/2,(Number(jali_phnms[4])+Number(jali_phnms[5])+Number(jali_phnms[10])+Number(jali_phnms[11]))/4,Number(jali_phnms[6]),Number(jali_phnms[7]),(Number(jali_phnms[8])+Number(jali_phnms[9]))/2];
		}
		count=0;
		playvsms=setInterval(play_visemes, 10);
		audio.play();
		fadeToAction( "talking3", 1 );
		}
		
		function play_visemes(){
			for (let i = 0; i < 15; i++) {
				head.morphTargetInfluences[ i ] = ocls_phnms[count][i];
				teeth.morphTargetInfluences[ i ] = ocls_phnms[count][i];
			}
			count++;
			if (count == ocls_phnms.length-1){
				clearInterval(playvsms);
				fadeToAction( "idle1", 1 );
				for (let i = 0; i < 15; i++) {
					head.morphTargetInfluences[ i ] = 0;
					teeth.morphTargetInfluences[ i ] = 0;
				}
				ocls_phnms=[];
			}
		}
			
		main();
		
		function fadeToAction( name, duration ) {

				previousAction = activeAction;
				activeAction = actions[ name ];

				if ( previousAction !== activeAction ) {

					previousAction.fadeOut( duration );

				}

				activeAction
					.reset()
					.setEffectiveTimeScale( 1 )
					.setEffectiveWeight( 1 )
					.fadeIn( duration )
					.play();

			}

	</script>


</html>
